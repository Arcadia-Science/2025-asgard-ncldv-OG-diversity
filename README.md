# 2025-Asgard-NCLDV-OG-Diversity

## Purpose

This repository accompanies the pub, "[Mapping the spectrum of archaeal protein sequenceâ€“structure relationships](https://doi.org/10.57844/arcadia-xfqs-5k8a)."

This repository contains the scripts and analysis notebooks used to investigate the relationship between sequence diversity and structural diversity within orthologous groups (OGs) from Asgard archaea. The primary motivation was to determined whether we could find global rules to characterize the relationship of protein sequence and structure in Asgard archaea proteomes, representing ~2 billion years of evolution. We found no correlation between structural and phylogenetic diversity, and only weak correlations between sequence and structural diversity. Instead, we found that the subset of orthogroups with the least structural diversity comprise protein families where the structure is effectively resistent to sequence divergence.

## Installation and Setup

This repository uses conda to manage software environments and installations. You can find operating system-specific instructions for installing miniconda [here](https://conda.io/projects/conda/en/latest/user-guide/install/index.html).

After installing conda and mamba, run the following commands to create the environment and set up the repository:

```bash
# Create the environment used for data processing and analysis
mamba env create -n asgard_gv_env --file envs/dev.yml
conda activate asgard_gv_env

# Install pre-commit hooks
pre-commit install
```

**Note on MAFFT:** The multiple sequence alignment scripts require the `mafft` binary. This is not installed via conda and must be installed separately. The version used in this study was `v7.5.26`. Please see the [MAFFT website](https://mafft.cbrc.jp/alignment/software/) for installation instructions.

## Data

### Input Data

The following large input data files are not included in this repository and must be downloaded from Zenodo (DOI: [10.5281/zenodo.16712749](https://doi.org/10.5281/zenodo.16712749)).

`proteome_database_v3.5.csv`: The primary input database containing protein sequences, OG assignments, and pre-computed annotations (domain counts, disorder, etc.) for Asgard archaea. This also contains Uniprot IDs, which we used to download structures from the AFDB API. Generated in a prior study (DOI: 10.5281/zenodo.15933360)

The following reference file is included in the repository:

`interpro_entry.txt`: Reference file from InterPro for mapping IPR domain IDs to human-readable names.

### Intermediate Data

These data files 

`data/intermediate/results_vs_mgnify_ESMA.m8`: This file logs results of the search against ESMAtlas

`data/intermediate/structural_summary.csv`: This file contains summary statistics on what fraction of proteins have associated structural predictions

`data/intermediate/structure_download_log.csv`: This file logs results of the UniprotKB AC search against the AlphaFold Database

### Results

The following files are generated by the scripts in the `scripts/` directory.

`results/final_master_og_properties_v2.csv`: The primary integrated data table generated by the analysis notebooks, containing merged sequence, structural, and phylogenetic diversity metrics for each OG.

`all_vs_all_structural_metrics.csv`: The raw output of the all-vs-all TM-align comparisons, containing pairwise TM-scores and RMSD values. This file is large and must be downloaded from Zenodo (DOI: 10.5281/zenodo.16712749)

`results/og_sequence_diversity_v3.csv`: Table of sequence-based diversity metrics (Hill Diversity, APSI, Shannon Entropy) for each OG.

`results/table_expected_vs_actual_tmscore_stats.csv`: This table contains results of statistical testing on the relationship between average pairwise sequence identity and median TM-score.

`df_per_column_conservation.csv`: Per-column Shannon entropy values for each position in the MSA of each OG. This file is large and must be downloaded from Zenodo (DOI: 10.5281/zenodo.16712749)

`results/table_high_diversity_rigid_quantification.csv`: This file contains statistics on structurally rigid orthogroups that exhibit notable sequence diversity.

`table_comprehensive_statistical_summary.csv`: This table contains the comprehensive results of statistical testing across orthogroups

## Overview

### Description of the Folder Structure

`scripts/`: Contains all Python scripts for the data processing pipeline (OG selection, MSA, tree building, diversity calculation, etc.).

`notebooks/`: Contains the `sequence_structure_notebook.ipynb` Jupyter notebook, which is used for exploratory data analysis and generating the figures for the publication.

`data/`: Contains raw and intermediate data files.

`results/`: Contains the primary data outputs from the analysis pipeline and notebooks.

`envs/`: Contains the conda environment definition file.

### Main Analysis Pipeline 

This section provides example commands to run the key scripts in this repository. The commands assume they are being run from the root directory of the project.

#### 1. OG selection and sequence extraction

From the existing Asgard archaea proteome database (proteome_database_v3.5.csv) we identified all Asgard orthogroups with >20 members (prepare_og_list.py) and extracted all amino acid sequences from those orthogroups into a single FASTA (fetch_og_sequences.py)

This is the core pipeline for generating the sequence and phylogenetic diversity metrics from a set of defined OGs.

#### 2. Extract OG Sequences

This script takes a curated list of OGs and extracts all member sequences from the main proteome database into individual FASTA files.

```bash
python scripts/fetch_og_sequences.py \
    --og-list-csv path/to/your/og_list.csv \
    --proteome-db path/to/your/proteome_database_v3.5.csv \
    --output-dir path/to/your/raw_og_fastas
```

#### 3. Generate Initial Multiple Sequence Alignments

This script runs MAFFT in parallel on the raw FASTA files generated in the previous step.

```bash
python scripts/run_initial_mafft_parallel.py \
    --input_dir path/to/your/raw_og_fastas \
    --output_dir path/to/your/initial_mafft_alignments \
    --log_dir path/to/your/initial_mafft_logs \
    --num_cores 8
```

#### 4. Filter Alignments by Length

This script filters the initial alignments to remove fragmentary sequences based on the median length of sequences in the alignment.

```bash
python scripts/filter_mafft_alignments_by_length.py \
    --input-dir path/to/your/initial_mafft_alignments \
    --output-dir path/to/your/mafft_len_filtered_output \
    --input-suffix ".aln"
```

#### 5. Refine Alignments

This script implements a full refinement pipeline: it unaligns the sequences, re-aligns them with MAFFT, and then trims the new alignment with TrimAl to produce the final MSAs for tree inference.

```bash
python scripts/refine_alignments.py \
    --input-dir path/to/your/mafft_len_filtered_output \
    --output-dir path/to/your/trimmed_fastas_for_trees \
    --input-suffix "_len_filtered.aln" \
    --output-suffix "_final_trimmed.fasta" \
    --max-workers 8
```

#### 6. Infer Phylogenetic Trees

This script runs FastTree in parallel on the final, trimmed and refined alignments to generate phylogenetic trees.

```bash
python scripts/run_fasttree_parallel.py \
    -i path/to/your/trimmed_fastas_for_trees \
    -o path/to/your/fasttree_output_final_trees \
    --input_suffix "_final_trimmed.fasta" \
    --output_suffix "_tree.nwk" \
    --cores 8
```

#### 7. Calculate All-vs-All Structural Metrics

This script performs the core structural comparison, running TM-align on all pairs of high-quality structures within each target OG.

```bash
python scripts/calculate_all_vs_all_metrics.py \
    --og-list-csv path/to/your/og_list.csv \
    --proteome-db path/to/your/proteome_database_v3.5.csv \
    --pdb-dir path/to/your/downloaded_structures/alphafold_structures \
    --output-csv path/to/your/all_vs_all_structural_metrics.csv \
    --max-workers 8
```

#### 8. Calculate Sequence Diversity Metrics

This final pipeline script reads the MSAs and trees to calculate Hill Diversity, APSI, and Shannon Entropy for each OG.

```bash
python scripts/calculate_sequence_diversity.py \
    --msa-dir path/to/your/trimmed_fastas_for_trees \
    --tree-dir path/to/your/fasttree_output_final_trees \
    --output-csv path/to/your/og_diversity_metrics.csv \
    --msa-suffix "_final_trimmed.fasta" \
    --tree-suffix "_tree.nwk"
```

#### 9. Data Integration and Analysis

All computed metrics were merged into a master dataframe. OGs were categorized into "Structurally Rigid," "Structurally Plastic," and "Intermediate" profiles based on the 25th and 75th percentiles of their Mean_TMscore and StdDev_TMscore. Open-ended exploration of these data was conducted in the `sequence_structure_notebook.ipynb` notebook.

#### 10. Hypothesis Testing & Visualization

The final analysis, also performed in the `sequence_structure_notebook.ipynb` notebook, tested several hypotheses:

a. The global correlation between sequence diversity (both Hill Diversity and APSI) and structural 	diversity  was assessed.

b. The distributions of domain count and intrinsic disorder were compared across structural profiles using KDE plots.

c. The relationship between sequence and structure was explored within specific functional families defined by their consensus domain architecture using faceted correlation plots.

d. Per-column Shannon entropy was analyzed to compare conservation patterns between structural profiles, leading to the "islands of conservation" hypothesis.

## Compute Specifications

Local Machine: Apple MacBook Pro M3 Max, 36 GB RAM (Used for scripting, data integration, statistical analysis, and figure generation).

AWS EC2: Used for the all-vs-all TM-align. Amazon Linux2 c6a32X large with 128 CPUs. 

Key Software: Python 3.10 (via Conda/Mamba), Pandas, NumPy, SciPy, Statsmodels, Plotly, arcadia-pycolor, BioPython, MAFFT, FastTree, TM-align.
